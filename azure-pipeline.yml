parameters:
  - name: ProjectName
    type: string
    default: 'fission'
  - name: DockerImageName
    type: string
    default: 'fission-bundle'
  - name: ProjectSrcFolder
    type: string
    default: ''
  - name: ProjectPath
    type: string
    default: ''
  - name: ContainerRegistry
    type: string
    default: 'SDLC EdenCore'
  - name: IsGitLFS
    type: boolean
    default: false
  - name: FetchSubmodules
    type: boolean
    default: false
  - name: RunSetupJob
    type: boolean
    default: true
  - name: DoRelease
    type: boolean
    default: true
  - name: HelmDeploy
    type: boolean
    default: true
  - name: PreSetup
    type: stepList
    default: []

variables:
  - name: GO_VERSION
    value: "1.18"

resources:
  repositories:
    - repository: OutSystems.CICDPlatform.PhoenixServicePipelineTemplates
      type: github
      ref: refs/tags/v2
      name: OutSystems/OutSystems.CICDPlatform.PhoenixServicePipelineTemplates
      endpoint: OutSystems-CICD Platform-Phoenix Cloud
    - repository: OutSystems.CICDPlatform.AzureCITemplates
      type: github
      ref: refs/tags/v1
      name: OutSystems/OutSystems.CICDPlatform.AzureCITemplates
      endpoint: OutSystems-CICD Platform-Phoenix Cloud

trigger:
  branches:
    include:
      - main-os
      - master
      - feature/mhh/sprint-7.6/RDDFC-409/Fork_the_main_fission_repo_so_that_we_can_implement_changes

pr: none

stages:
  - stage: BuildAndPublish
    displayName: 'Build and Publish'
    dependsOn: [ ]
    variables:
      - group: Phoenix Variables
      - template: setup/vars.yml@OutSystems.CICDPlatform.PhoenixServicePipelineTemplates
    jobs:
      ########################################################################################################################
      # SETUP JOB - Any setup tasks to run before the parallel jobs
      ########################################################################################################################
      - job: Setup
        displayName: 'Setup'
        timeoutInMinutes: 10
        pool:
          vmImage: 'ubuntu-20.04'
        dependsOn: []
        condition: eq(${{ parameters.RunSetupJob }}, true)
        steps:
          - template: setup/checkout.yml@OutSystems.CICDPlatform.PhoenixServicePipelineTemplates
            parameters:
              IsGitLFS: ${{ parameters.IsGitLFS }}
          - template: setup/set-variables-go.yml@OutSystems.CICDPlatform.PhoenixServicePipelineTemplates
            parameters:
              DockerImageName: ${{ parameters.DockerImageName }}
              ProjectName: ${{ parameters.ProjectName }}
              ProjectSrcFolder: ${{ parameters.ProjectSrcFolder }}
              ProjectPath: ${{ parameters.ProjectPath }}
          # PreSetup Step
          - ${{ each step in parameters.PreSetup }}:
              - ${{ each pair in step }}:
                  ${{ pair.key }}: ${{ pair.value }}
#          - template: setup/phoenix-versioning.yml@OutSystems.CICDPlatform.AzureCITemplates
#            parameters:
#              ScriptsDir: $(TemplatePath)
#              WorkingDir: $(ProjectPath)
#              GithubToken: $(GITHUB_TOKEN)
#              GithubConnection: 'SDLC Phoenix Cloud'
#              DoRelease: ${{ parameters.DoRelease }}

      - job: Release
        displayName: 'Build'
        dependsOn:
          - Setup
        condition: eq(dependencies.Setup.result, 'Succeeded')
        pool:
          vmImage: 'ubuntu-20.04'
        variables:
          ${{ if eq(parameters.RunSetupJob, true) }}:
            ServiceVersion: 0.0.1
          ${{ if ne(parameters.RunSetupJob, true) }}:
            ServiceVersion: $(Build.BuildId)
        steps:
          - template: setup/checkout.yml@OutSystems.CICDPlatform.PhoenixServicePipelineTemplates
            parameters:
              IsGitLFS: ${{ parameters.IsGitLFS }}
              FetchSubmodules: ${{ parameters.FetchSubmodules }}
          - template: setup/set-variables-go.yml@OutSystems.CICDPlatform.PhoenixServicePipelineTemplates
            parameters:
              DockerImageName: ${{ parameters.DockerImageName }}
              ProjectName: ${{ parameters.ProjectName }}
              ProjectSrcFolder: ${{ parameters.ProjectSrcFolder }}
              ProjectPath: ${{ parameters.ProjectPath }}
          - template: setup/docker-acr-login.yml@OutSystems.CICDPlatform.AzureCITemplates
            parameters:
              ContainerRegistry: ${{ parameters.ContainerRegistry }}
          - task: GoTool@0
            inputs:
              version: "$(GO_VERSION)"
            displayName: Install Go
          - bash: |
              echo "Installing goreleaser"
              echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
              sudo apt update && sudo apt install goreleaser
              echo "Running goreleaser build"
              GOOS=linux GOARCH=amd64 goreleaser build --snapshot --rm-dist --single-target
            workingDirectory: $(ProjectPath)
          ########################################################################################################################
          # PUSH TO ACR
          ########################################################################################################################
          # Push to Core ACR on pass or fail
          - template: publish/docker-push.yml@OutSystems.CICDPlatform.AzureCITemplates
            parameters:
              ServiceConnection: 'SDLC EdenCore'
              SourceImageName: $(DockerImageName)
              SourceImageTag: $(ServiceVersion)
              Condition: and(succeededOrFailed(), eq('${{ parameters.DoRelease }}', 'true'))
          # Push image to ECR
          - task: ECRPushImage@1
            displayName: 'Publish Docker image to ECR (version tag)'
            condition: and(succeeded(), eq('${{ parameters.HelmDeploy }}', 'true'))
            inputs:
              awsCredentials: 'sdlc_datafabric_core'
              regionName: 'eu-central-1'
              imageSource: 'imagename'
              sourceImageName: $(DockerImageName)
              sourceImageTag: $(ServiceVersion)
              repositoryName: $(DockerImageName)
              pushTag: $(ServiceVersion)
              autoCreateRepository: true
